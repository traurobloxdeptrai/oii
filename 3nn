local player = game:GetService("Players").LocalPlayer
local storage = game:GetService("ReplicatedStorage")
local runService = game:GetService("RunService")
local Modules = storage.Modules

local HITBOX_LIMBS = {
    "RightLowerArm", "RightUpperArm", "LeftLowerArm", 
    "LeftUpperArm", "RightHand", "LeftHand", 
    "HumanoidRootPart", "Head"
}

local function IsEntityAlive(entity)
    if not (entity and entity.Parent) then return false end
    local humanoid = entity:FindFirstChildOfClass("Humanoid")
    return humanoid and humanoid.Health > 0
end

SendHitsToServer = nil
GetCombatThread = false

task.spawn(function()
    local flag1, flag2 = pcall(function() return require(Modules.Flags).COMBAT_REMOTE_THREAD or false end)
    GetCombatThread = flag1 and flag2

    task.defer(function()
        local playerScripts = player:WaitForChild("PlayerScripts")

        for _, v in ipairs(playerScripts:GetChildren()) do
            if v:IsA("LocalScript") and v.Name == "AccessoryRenderer" then
                local okgetsenv, env = pcall(getsenv, v)
                if okgetsenv and env then
                    SendHitsToServer = (env._G and env._G.SendHitsToServer) or env.SendHitsToServer
                    return
                end
            end
        end

        playerScripts.ChildAdded:Connect(function(c)
            if c:IsA("LocalScript") and c.Name == "AccessoryRenderer" then
                task.wait(0.2)
                local okgetsenv, env = pcall(getsenv, c)
                if okgetsenv and env then
                    SendHitsToServer = (env._G and env._G.SendHitsToServer) or env.SendHitsToServer
                end
            end
        end)
    end)
end)

local function GetEnemiesInRange(character, range)
    local targets = {}
    local playerPos = character:GetPivot().Position
    local enemiesFolder = workspace:FindFirstChild("Enemies")
    
    if enemiesFolder then
        local children = enemiesFolder:GetChildren()
        for i = 1, #children do
            local enemy = children[i]
            local root = enemy:FindFirstChild("HumanoidRootPart")
            if root and IsEntityAlive(enemy) then
                if (root.Position - playerPos).Magnitude <= (range + 2) then
                    table.insert(targets, enemy)
                end
            end
            if #targets >= 8 then break end 
        end
    end
    
    if #targets < 8 then
        local players = game:GetService("Players"):GetPlayers()
        for i = 1, #players do
            local v = players[i]
            if v ~= player and v.Character then
                local root = v.Character:FindFirstChild("HumanoidRootPart")
                if root and IsEntityAlive(v.Character) then
                    if (root.Position - playerPos).Magnitude <= range then
                        table.insert(targets, v.Character)
                    end
                end
            end
            if #targets >= 8 then break end
        end
    end
    return targets
end

function AttackNoCoolDown()
    local char = player.Character
    if not (char and char:FindFirstChildOfClass("Tool")) then return end
    
    local enemies = GetEnemiesInRange(char, 55)
    if #enemies == 0 then return end

    local net = storage:FindFirstChild("Modules") and storage.Modules:FindFirstChild("Net")
    if not net then return end
           
    local atkRE = net:FindFirstChild("RE/RegisterAttack")
    local hitRE = net:FindFirstChild("RE/RegisterHit")
    
    if atkRE and hitRE then
        local hitData = {}
        local mainPart = nil
        
        for i = 1, #enemies do
            local target = enemies[i]
            local limb = target:FindFirstChild(HITBOX_LIMBS[math.random(1, #HITBOX_LIMBS)]) or target.PrimaryPart
            if limb then
                table.insert(hitData, {target, limb})
                mainPart = limb
            end
        end

        if mainPart then
            if (GetCombatThread and SendHitsToServer) then
                atkRE:FireServer(0)
                SendHitsToServer(mainPart, hitData)
            elseif GetCombatThread then
                atkRE:FireServer(0)
                hitRE:FireServer(mainPart, hitData)
            end
        end
    end
end

local VirtualUser = game:GetService("VirtualUser")
local function Actived()
    local char = player.Character
    local tool = char and char:FindFirstChildOfClass("Tool")
    if tool then
        tool:Activate()
        VirtualUser:CaptureController()
        VirtualUser:ClickButton1(Vector2.new(850, 520))
    end
end
task.spawn(function()
    while true do
        task.wait(math.random(7, 12) / 100)  
        if _G.Seriality == true then
            pcall(function()
                local char = player.Character
                if char then
                    local tool = char:FindFirstChildOfClass("Tool")
                    if tool then
                        AttackNoCoolDown()
                        local isFruit = false
                        if tool.ToolTip == "Blox Fruit" or (tool:FindFirstChild("ToolTip") and tool.ToolTip.Value == "Blox Fruit") then
                            isFruit = true
                        end

                        if isFruit then
                            local canAtk, _ = get_Monster()
                            if canAtk then
                                Actived()
                                local remote = tool:FindFirstChild('LeftClickRemote')
                                if remote then
                                    remote:FireServer(Vector3.new(0.01, -500, 0.01), 1, true)
                                    remote:FireServer(false)
                                end
                            end
                        end
                    end
                end
            end)
        end
    end
end)

_G.Seriality = true
